<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ローグっぽい何か コード解説ドキュメント（最新版）</title>
  <style>
    /* 楽しくポップな全体スタイル */
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: radial-gradient(circle at top left, #ffebcd, #f4a460);
      margin: 20px;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3 {
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      color: #d2691e;
    }
    h1 {
      font-size: 2.8em;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 2.2em;
      margin-top: 40px;
    }
    h3 {
      font-size: 1.8em;
      margin-top: 30px;
    }
    .section {
      background: rgba(255,255,255,0.9);
      border: 2px dashed #ff7f50;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 40px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    pre {
      background: #fff8dc;
      padding: 15px;
      border: 1px solid #deb887;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
    }
    code {
      font-family: Consolas, "Courier New", monospace;
      color: #8b4513;
    }
    .note {
      background-color: #ffefd5;
      border-left: 6px solid #ff6347;
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-style: italic;
    }
    a.button {
      background-color: #ff7f50;
      color: #fff;
      padding: 8px 15px;
      text-decoration: none;
      border-radius: 20px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    a.button:hover {
      background-color: #ff6347;
    }
  </style>
</head>
<body>
  <h1>ローグっぽい何か コード解説ドキュメント（最新版）</h1>
  <p>
    この解説書は、HTML/CSS/JavaScript で実装されたローグライクゲームの最新版ソースコード（インベントリ統合版）に基づいています。基本部分の構造、応用的な処理、そして今回追加されたインベントリシステムについて詳しく解説しています。（&#8203;:contentReference[oaicite:2]{index=2}&#8203;:contentReference[oaicite:3]{index=3}）
  </p>
  
  <!-- 1. 基本 -->
  <div class="section">
    <h2>1. 基本</h2>
    <p>
      このゲームは、HTML上にゲーム画面（グリッド状のタイル）とUIバーを配置し、JavaScriptでダンジョン生成やターン進行、キャラクターの移動、敵との衝突判定などの基本ロジックを実装しています。
    </p>
    
    <h3>1.1 CONFIG オブジェクト</h3>
    <p>
      ゲーム全体のパラメータ（マップサイズ、初期体力、各種ターンサイクル、インベントリの最大数など）を管理する定数オブジェクトです。
    </p>
    <pre><code>const CONFIG = {
  WIDTH: 40,
  HEIGHT: 32,
  INITIAL_HP: 8,
  REST_CYCLE: 5,
  GENERATE_ENEMY_CYCLE: 30,
  HUNGER_CYCLE: 5,
  MIN_ENEMY_MULTIPLIER: 1.1,
  MAX_ENEMY_MULTIPLIER: 1.4,
  INVENTORY_MAX: 10
};</code></pre>
    
    <h3>1.2 基本クラス群</h3>
    <p>
      ゲーム内のエンティティは、基本となる <code>BaseEntity</code> クラスから派生しています。ここでは、<code>Player</code>、<code>Enemy</code> など、基本的なキャラクターの管理を行います。
    </p>
    <pre><code>// BaseEntity: 全エンティティの基本クラス
class BaseEntity {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
}

// Player: プレイヤーの情報と能力
class Player extends BaseEntity {
  constructor(x, y, initialHP) {
    super(x, y);
    this.hp = initialHP;
    this.maxHp = initialHP;
    this.attack = 2;
    this.healAmount = 3;
    this.level = 1;
    this.exp = 0;
    this.hunger = 100;
    this.maxHunger = 100;
    this.inventory = []; // インベントリ（最大10個）
  }
}

// Enemy: 敵キャラクター
class Enemy extends BaseEntity {
  constructor(x, y, hp) {
    super(x, y);
    this.hp = hp;
  }
  takeDamage(damage) {
    this.hp -= damage;
  }
}</code></pre>
    
    <h3>1.3 DungeonMap クラス</h3>
    <p>
      ダンジョンの自動生成、部屋作成、部屋同士の接続、視界の管理などを行うクラスです。各部屋はランダムなサイズ・位置で生成され、通路で接続されます。
    </p>
    <pre><code>class DungeonMap {
  constructor(width, height) {
    this.width = width;
    this.height = height;
    this.grid = [];
    this.visible = [];
    this.rooms = [];
    this.reset();
  }
  reset() {
    this.grid = Array.from({ length: this.height }, () => Array(this.width).fill('🌳'));
    this.visible = Array.from({ length: this.height }, () => Array(this.width).fill(false));
    this.rooms = [];
  }
  createRoom() {
    let w = randomInt(5, 10);
    let h = randomInt(4, 8);
    let x = randomInt(1, this.width - w - 1);
    let y = randomInt(1, this.height - h - 1);
    for (let i = y; i < y + h; i++) {
      for (let j = x; j < x + w; j++) {
        this.grid[i][j] = ' '; // 空白タイル
      }
    }
    this.rooms.push({ x, y, w, h });
  }
  // connectRooms, generate, revealRoom, revealAround などのメソッド...
}</code></pre>
  </div>
  
  <!-- 2. 応用 -->
  <div class="section">
    <h2>2. 応用</h2>
    <p>
      基本部分に加え、ゲーム内の動作を支える応用処理として、ターン進行や非同期処理、敵の移動アルゴリズム、衝突判定などのロジックが実装されています。
    </p>
    
    <h3>2.1 ターン進行と非同期処理</h3>
    <p>
      各ターンごとに敵の生成、ハンガーの更新、休憩による体力回復などが行われ、<code>advanceTurn()</code> や <code>queueTimeout()</code> でタイミングを管理しています。
    </p>
    <pre><code>class Game {
  // ターン進行処理
  advanceTurn() {
    this.generateEnemyCycle[0] = (this.generateEnemyCycle[0] + 1) % this.generateEnemyCycle[1];
    this.hungerCycle[0] = (this.hungerCycle[0] + 1) % this.hungerCycle[1];
  }

  // 非同期処理で動作のタイミングを調整
  queueTimeout(callback, delay) {
    this.acceptingInput = false;
    const id = setTimeout(() => {
      callback();
      this.timeoutQueue = this.timeoutQueue.filter(t => t !== id);
      if (this.timeoutQueue.length === 0) this.acceptingInput = true;
      this.render();
    }, delay);
    this.timeoutQueue.push(id);
  }
}</code></pre>
    
    <h3>2.2 敵のAIと衝突判定</h3>
    <p>
      敵はプレイヤーの位置に基づき移動し、隣接した場合は攻撃を仕掛けます。敵の移動方向はプレイヤーへのベクトル計算により決定され、障害物チェックも行われます。
    </p>
    <pre><code>moveEnemies(nextPlayerX, nextPlayerY) {
  this.enemies.forEach((enemy, idx) => {
    const dx = Math.abs(enemy.x - this.player.x);
    const dy = Math.abs(enemy.y - this.player.y);
    this.queueTimeout(() => {
      if ((dx === 1 && dy === 0) || (dx === 0 && dy === 1)) {
        this.player.hp--;
        EffectsManager.showEffect(this.gameContainer, this.player.x, this.player.y, "-1", "damage-me");
        return;
      }
    }, 100);
    const dirX = Math.sign(this.player.x - enemy.x);
    const dirY = Math.sign(this.player.y - enemy.y);
    // 壁や他の敵との衝突チェックの処理...
  });
}</code></pre>
  </div>
  
  <!-- 3. インベントリ統合 -->
  <div class="section">
    <h2>3. インベントリ統合</h2>
    <p>
      今回の最新版では、プレイヤーがマップ上のアイテム（例：すし、パン、大きなパン）を拾い、インベントリに統合できるようになりました。<code>InventoryItem</code> クラスを導入し、アイテムの使用やドロップが可能です。
    </p>
    
    <h3>3.1 InventoryItem クラス</h3>
    <p>
      アイテムの名前と使用時の動作を定義するクラスです。使用時には、プレイヤーの体力や満腹度を回復する効果が実装されています。
    </p>
    <pre><code>// InventoryItem: インベントリ用アイテム
class InventoryItem extends BaseEntity {
  constructor(x, y, name, useFunction) {
    super(x, y);
    this.name = name;
    this.use = useFunction; // 使用時の処理
  }
}</code></pre>
    
    <h3>3.2 インベントリのピックアップと表示</h3>
    <p>
      プレイヤーがマップ上のアイテムに接触すると、所持数（最大10個）内であればインベントリに追加され、アイテム取得時にはエフェクトが表示されます。また、<code>render()</code> 内でインベントリが開いている場合、オーバーレイ形式で所持品が表示されます。
    </p>
    <pre><code>// updateData 内でのアイテムピックアップ処理
this.items = this.items.filter(item => {
  if (item.x === this.player.x && item.y === this.player.y) {
    if (this.player.inventory.length < CONFIG.INVENTORY_MAX) {
      this.player.inventory.push(item);
      EffectsManager.showEffect(this.gameContainer, this.player.x, this.player.y, "GET");
      return false;
    }
  }
  return true;
});

// render() 内のインベントリ表示
if (this.inventoryOpen) {
  html += `<div class="inventory-modal">`;
  html += `<h3>所持品 (${this.player.inventory.length}/${CONFIG.INVENTORY_MAX})</h3>`;
  if (this.player.inventory.length === 0) {
    html += `<p>(なし)</p>`;
  } else {
    html += `<ul>`;
    for (let i = 0; i < this.player.inventory.length; i++) {
      let selected = (i === this.inventorySelection) ? ">> " : "";
      let itemName = this.player.inventory[i].name || "アイテム";
      html += `<li class="${(i===this.inventorySelection) ? 'selected' : ''}">${selected}${itemName}</li>`;
    }
    html += `</ul>`;
    html += `<p>u: 使用, d: 置く, Esc/e: 閉じる</p>`;
  }
  html += `</div>`;
}</code></pre>
    
    <h3>3.3 インベントリ操作の入力処理</h3>
    <p>
      インベントリ表示中は、上下キーで選択、<code>u</code> で使用、<code>d</code> でドロップ、<code>Esc</code> または <code>e</code> で閉じる操作が可能です。<code>processInventoryInput()</code> により処理されます。
    </p>
    <pre><code>processInventoryInput(event) {
  if (event.key === 'ArrowUp') {
    if (this.player.inventory.length > 0) {
      this.inventorySelection = (this.inventorySelection - 1 + this.player.inventory.length) % this.player.inventory.length;
      this.render();
    }
    return;
  }
  if (event.key === 'ArrowDown') {
    if (this.player.inventory.length > 0) {
      this.inventorySelection = (this.inventorySelection + 1) % this.player.inventory.length;
      this.render();
    }
    return;
  }
  if (event.key === 'u') {
    let item = this.player.inventory[this.inventorySelection];
    if (item && item.use) {
      item.use(this);
      this.player.inventory.splice(this.inventorySelection, 1);
      if (this.inventorySelection >= this.player.inventory.length) {
        this.inventorySelection = this.player.inventory.length - 1;
      }
    }
    this.inventoryOpen = false;
    this.render();
    return;
  }
  if (event.key === 'd') {
    let item = this.player.inventory[this.inventorySelection];
    if (item) {
      item.x = this.player.x;
      item.y = this.player.y;
      this.items.push(item);
      this.player.inventory.splice(this.inventorySelection, 1);
      if (this.inventorySelection >= this.player.inventory.length) {
        this.inventorySelection = this.player.inventory.length - 1;
      }
    }
    this.inventoryOpen = false;
    this.render();
    return;
  }
  if (event.key === 'Escape' || event.key === 'e') {
    this.inventoryOpen = false;
    this.render();
    return;
  }
}</code></pre>
    
    <div class="note">
      <p>
        インベントリ機能の追加により、プレイヤーはマップ上でアイテムを集め、使用やドロップといった操作が可能になりました。これにより、戦略性がさらに向上しています。
      </p>
    </div>
  </div>
  
  <!-- 4. 拡張 -->
  <div class="section">
    <h2>4. 拡張</h2>
    <p>
      現在のコードはシンプルな基盤を構築していますが、今後さらなる拡張が可能です。以下は、いくつかの拡張アイディアです。
    </p>
    <ul>
      <li>新たな敵キャラクターや特殊能力を持つボスの実装</li>
      <li>アイテム効果の多様化（攻撃強化、シールド、スピードアップなど）</li>
      <li>ダンジョン生成アルゴリズムの改良（迷宮や隠し部屋の追加）</li>
      <li>UIやサウンドエフェクトの強化（Canvas API や Web Audio API の活用）</li>
      <li>マルチプレイヤー機能の検討</li>
    </ul>
  </div>
  
  <h2>まとめ</h2>
  <p>
    この最新版のゲームソースコードは、基本的なローグライクの要素に加え、インベントリ統合などの新機能を搭載しています。各セクションのサンプルコードを参考に、さらなる機能追加や改良を検討してください。楽しく、かつ戦略性のあるゲーム作りを目指しましょう！
  </p>
  
  <div class="note">
    <p>
      ※ 本解説書のサンプルコードは実際のプログラムからの抜粋および拡張例です。実装環境や目的に合わせて適宜調整してください。
    </p>
  </div>
  
  <p>楽しいコードライフを！ <a class="button" href="#">もっと学ぶ</a></p>
  
</body>
</html>
